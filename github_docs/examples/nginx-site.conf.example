# =============================================================================
# Nginx Site Configuration - Secure Web Application
# =============================================================================
#
# This is an example configuration for a secure Nginx site.
# Copy to /etc/nginx/sites-available/ and adjust as needed.
#
# Features:
# - HTTPS redirect
# - Security headers
# - HTTP Basic Authentication
# - Sensitive path blocking
# - SSL/TLS 1.3
#
# =============================================================================

# =============================================================================
# HTTPS Server Block (Main)
# =============================================================================

server {
    # Listen on HTTPS
    listen 443 ssl;
    server_name yourdomain.com;

    # Document root
    root /var/www/myapp/output;
    index index.html;

    # =========================================================================
    # SSL Configuration (managed by Certbot)
    # =========================================================================
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # =========================================================================
    # SECURITY HEADERS
    # =========================================================================
    
    # Prevent clickjacking attacks
    # Only allow framing from same origin
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME type sniffing
    # Browser must respect declared Content-Type
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS filter (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Control referrer information
    # Send full URL only to same origin, origin only to cross-origin
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (uncomment and customize if needed)
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;

    # HTTP Strict Transport Security (uncomment after SSL is working)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # =========================================================================
    # AUTHENTICATION
    # =========================================================================
    
    # HTTP Basic Auth
    # Create password file: htpasswd -cb /etc/nginx/.htpasswd user password
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # =========================================================================
    # LOCATIONS
    # =========================================================================

    # Main location
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Block access to sensitive files and directories
    location ~ /(.env|.git|.gitignore|data|backup|logs|config|venv|__pycache__|node_modules) {
        deny all;
        return 404;
    }

    # Block access to hidden files (except .well-known for Let's Encrypt)
    location ~ /\.(?!well-known) {
        deny all;
        return 404;
    }

    # Block common exploit attempts
    location ~* (\.php|\.asp|\.aspx|\.jsp|\.cgi)$ {
        deny all;
        return 404;
    }

    # =========================================================================
    # LOGGING
    # =========================================================================
    
    access_log /var/log/nginx/myapp_access.log;
    error_log /var/log/nginx/myapp_error.log;

    # =========================================================================
    # PERFORMANCE (Optional)
    # =========================================================================

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # Browser caching for static files
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# =============================================================================
# HTTP to HTTPS Redirect
# =============================================================================

server {
    listen 80;
    server_name yourdomain.com;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$host$request_uri;
}

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
#
# 1. Copy this file:
#    cp nginx-site.conf.example /etc/nginx/sites-available/myapp.conf
#
# 2. Edit and replace:
#    - yourdomain.com → your actual domain
#    - /var/www/myapp → your actual path
#
# 3. Create symlink:
#    ln -sf /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/
#
# 4. Remove default site:
#    rm -f /etc/nginx/sites-enabled/default
#
# 5. Test configuration:
#    nginx -t
#
# 6. Reload Nginx:
#    systemctl reload nginx
#
# 7. Get SSL certificate:
#    certbot --nginx -d yourdomain.com
#
# =============================================================================
